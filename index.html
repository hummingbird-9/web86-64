<!doctype html>
<html>
<head>
    <title>64-bit Browser Emulator</title>
    <style>
        body { background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 20px; overflow-x: hidden; }
        #screen_container { 
            margin: 20px auto; 
            background: #000; 
            border: 5px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: inline-block; 
            position: relative;
        }
        canvas { display: block; image-rendering: pixelated; }
        
        /* Console Styles - Top Right */
        #log-console {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            height: 200px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            border: 1px solid #444;
            font-size: 11px;
            text-align: left;
            padding: 10px;
            overflow-y: auto;
            z-index: 1000;
            pointer-events: none; /* Allows clicks to pass through if needed */
        }

        .controls { 
            background: #222;
            padding: 20px; 
            border: 1px solid #444; 
            display: inline-block; 
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, button { 
            background: #333; color: #fff; border: 1px solid #555; 
            padding: 8px; border-radius: 4px; cursor: pointer;
        }
        button:hover { background: #444; border-color: #00ff00; }
        #status { color: #aaa; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="log-console">--- SYSTEM LOGS ---<br></div>

    <h1>64-bit OS Web Runner</h1>
    
    <div class="controls">
        <div style="margin-bottom: 15px;">
            <label for="iso-file">Select ISO:</label>
            <input type="file" id="iso-file" accept=".iso">
        </div>
        <div>
            <label>RAM (MB):</label>
            <input type="number" id="ram-size" value="1024" min="256" max="4096">
            <button id="start-btn">BOOT ISO</button>
            <button id="fullscreen-btn">FULLSCREEN</button>
        </div>
        <div id="status">Ready.</div>
    </div>

    <br>

    <div id="screen_container">
        <div style="white-space: pre; font-family: Courier, monospace; font-size: 14px;"></div>
        <canvas></canvas>
    </div>

    <script src="lib/libv86.js"></script>
    <script>
        const logBox = document.getElementById("log-console");
        const startBtn = document.getElementById("start-btn");
        const status = document.getElementById("status");

        // Custom function to log to our top-right console
        function customLog(message) {
            const entry = document.createElement("div");
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message); // Still logs to actual dev tools
        }

        // Fullscreen Logic
        document.getElementById("fullscreen-btn").onclick = function() {
            const elem = document.getElementById("screen_container");
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            customLog("Entering Fullscreen Mode");
        };

        startBtn.onclick = function() {
            const fileInput = document.getElementById("iso-file");
            const ramSize = parseInt(document.getElementById("ram-size").value);

            if (fileInput.files.length === 0) {
                alert("Please select an ISO file!");
                return;
            }

            const file = fileInput.files[0];
            const isoURL = URL.createObjectURL(file);
            
            status.innerText = "Initializing 64-bit engine...";
            customLog(`Loading ISO: ${file.name}`);
            startBtn.disabled = true;

            const emulator = new V86Starter({
                wasm_path: "webassembly/v86_64.wasm", 
                memory_size: ramSize * 1024 * 1024,
                vga_canvas: document.querySelector("#screen_container canvas"),
                screen_container: document.querySelector("#screen_container"),
                bios: { url: "bios/seabios.bin" }, 
                vga_bios: { url: "bios/vgabios.bin" },
                cdrom: { url: isoURL },
                autostart: true,
            });

            emulator.add_listener("emulator-ready", function() {
                status.innerText = "Running: " + file.name;
                customLog("v86 Emulator Ready & Booting...");
            });

            // Log instruction errors or memory warnings
            window.onerror = function(msg) {
                customLog(`ERROR: ${msg}`);
            };
        };
    </script>
</body>
</html>
